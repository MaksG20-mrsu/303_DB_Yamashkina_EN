<?php
/**
 * Скрипт для создания и заполнения базы данных SQLite
 */

// Конфигурация
$databaseFile = __DIR__ . '/students.db';

// Проверяем, существует ли файл базы данных
if (file_exists($databaseFile)) {
    unlink($databaseFile); // Удаляем старую базу данных
    echo "Старая база данных удалена.\n";
}

try {
    // Создаем подключение к SQLite
    $pdo = new PDO("sqlite:" . $databaseFile);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    echo "Создание базы данных SQLite...\n";
    
    // Создание таблицы студентов
    $sql = "
    CREATE TABLE IF NOT EXISTS students (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        group_number VARCHAR(10) NOT NULL,
        study_program VARCHAR(100) NOT NULL,
        last_name VARCHAR(50) NOT NULL,
        first_name VARCHAR(50) NOT NULL,
        middle_name VARCHAR(50),
        gender VARCHAR(1) CHECK(gender IN ('М', 'Ж')) NOT NULL,
        birth_date DATE NOT NULL,
        student_card_number VARCHAR(20) UNIQUE NOT NULL,
        graduation_year INTEGER NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    ";
    
    $pdo->exec($sql);
    echo "Таблица 'students' создана успешно.\n";
    
    // Создание индексов для оптимизации запросов
    $pdo->exec("CREATE INDEX idx_group_number ON students(group_number);");
    $pdo->exec("CREATE INDEX idx_graduation_year ON students(graduation_year);");
    $pdo->exec("CREATE INDEX idx_last_name ON students(last_name);");
    $pdo->exec("CREATE INDEX idx_full_name ON students(last_name, first_name);");
    
    echo "Индексы созданы успешно.\n";
    
    // Вставка тестовых данных
    echo "Заполнение базы тестовыми данными...\n";
    
    $students = [
        // ИТ-101 (выпуск 2025)
        ['ИТ-101', 'Информационные технологии', 'Иванов', 'Иван', 'Иванович', 'М', '2000-05-15', 'ИТ2021001', 2025],
        ['ИТ-101', 'Информационные технологии', 'Петрова', 'Анна', 'Сергеевна', 'Ж', '2001-02-20', 'ИТ2021002', 2025],
        ['ИТ-101', 'Информационные технологии', 'Сидоров', 'Алексей', 'Петрович', 'М', '2000-11-30', 'ИТ2021003', 2025],
        ['ИТ-101', 'Информационные технологии', 'Кузнецова', 'Екатерина', 'Александровна', 'Ж', '2001-07-12', 'ИТ2021004', 2025],
        ['ИТ-101', 'Информационные технологии', 'Морозов', 'Дмитрий', 'Сергеевич', 'М', '2000-09-25', 'ИТ2021005', 2025],
        
        // ПИ-201 (выпуск 2024)
        ['ПИ-201', 'Программная инженерия', 'Козлова', 'Мария', 'Александровна', 'Ж', '1999-08-12', 'ПИ2020001', 2024],
        ['ПИ-201', 'Программная инженерия', 'Васильев', 'Дмитрий', 'Олегович', 'М', '2000-03-25', 'ПИ2020002', 2024],
        ['ПИ-201', 'Программная инженерия', 'Никитин', 'Артем', 'Викторович', 'М', '1999-12-05', 'ПИ2020003', 2024],
        ['ПИ-201', 'Программная инженерия', 'Орлова', 'Ольга', 'Игоревна', 'Ж', '2000-06-18', 'ПИ2020004', 2024],
        
        // КБ-301 (выпуск 2026)
        ['КБ-301', 'Кибербезопасность', 'Федоров', 'Сергей', 'Викторович', 'М', '2002-07-08', 'КБ2022001', 2026],
        ['КБ-301', 'Кибербезопасность', 'Морозова', 'Елена', 'Дмитриевна', 'Ж', '2002-01-18', 'КБ2022002', 2026],
        ['КБ-301', 'Кибербезопасность', 'Григорьев', 'Андрей', 'Павлович', 'М', '2002-11-30', 'КБ2022003', 2026],
        ['КБ-301', 'Кибербезопасность', 'Титова', 'Виктория', 'Романовна', 'Ж', '2003-02-14', 'КБ2022004', 2026],
        ['КБ-301', 'Кибербезопасность', 'Белов', 'Максим', 'Анатольевич', 'М', '2002-08-22', 'КБ2022005', 2026],
        
        // ИВТ-102 (выпуск 2025)
        ['ИВТ-102', 'Информатика и вычислительная техника', 'Николаев', 'Андрей', 'Игоревич', 'М', '2001-04-05', 'ИВТ2021004', 2025],
        ['ИВТ-102', 'Информатика и вычислительная техника', 'Захарова', 'Юлия', 'Владимировна', 'Ж', '2001-09-19', 'ИВТ2021005', 2025],
        ['ИВТ-102', 'Информатика и вычислительная техника', 'Киселев', 'Павел', 'Александрович', 'М', '2001-12-03', 'ИВТ2021006', 2025],
        
        // РИ-401 (выпуск 2023 - неактивная группа)
        ['РИ-401', 'Радиоэлектроника', 'Семенов', 'Владимир', 'Петрович', 'М', '1998-03-15', 'РИ2019001', 2023],
        ['РИ-401', 'Радиоэлектроника', 'Волкова', 'Татьяна', 'Сергеевна', 'Ж', '1998-11-28', 'РИ2019002', 2023],
        
        // Новые группы для демонстрации
        ['ВМ-501', 'Вычислительная математика', 'Лебедев', 'Константин', 'Максимович', 'М', '2003-05-10', 'ВМ2023001', 2027],
        ['ВМ-501', 'Вычислительная математика', 'Соколова', 'Анастасия', 'Андреевна', 'Ж', '2003-08-22', 'ВМ2023002', 2027],
        
        ['ИСП-202', 'Информационные системы и программирование', 'Егоров', 'Михаил', 'Дмитриевич', 'М', '2000-10-07', 'ИСП2020005', 2024],
        ['ИСП-202', 'Информационные системы и программирование', 'Попова', 'Светлана', 'Викторовна', 'Ж', '2000-04-16', 'ИСП2020006', 2024]
    ];
    
    // Подготовленный запрос для вставки данных
    $stmt = $pdo->prepare("
        INSERT INTO students (
            group_number, study_program, last_name, first_name, middle_name, 
            gender, birth_date, student_card_number, graduation_year
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    ");
    
    $insertedCount = 0;
    foreach ($students as $student) {
        try {
            $stmt->execute($student);
            $insertedCount++;
        } catch (PDOException $e) {
            echo "Ошибка при вставке студента {$student[7]}: " . $e->getMessage() . "\n";
        }
    }
    
    echo "Вставлено {$insertedCount} записей студентов.\n";
    
    // Проверяем данные
    $stmt = $pdo->query("SELECT COUNT(*) as total FROM students");
    $total = $stmt->fetch(PDO::FETCH_ASSOC)['total'];
    
    $stmt = $pdo->query("
        SELECT 
            group_number, 
            COUNT(*) as student_count,
            MIN(graduation_year) as min_year,
            MAX(graduation_year) as max_year
        FROM students 
        GROUP BY group_number 
        ORDER BY group_number
    ");
    
    $groups = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    echo "\nСтатистика по группам:\n";
    echo str_repeat("-", 60) . "\n";
    echo sprintf("%-10s | %-15s | %-12s | %-12s\n", "Группа", "Кол-во студентов", "Мин. год", "Макс. год");
    echo str_repeat("-", 60) . "\n";
    
    foreach ($groups as $group) {
        echo sprintf("%-10s | %-15s | %-12s | %-12s\n", 
            $group['group_number'], 
            $group['student_count'],
            $group['min_year'],
            $group['max_year']
        );
    }
    
    echo str_repeat("-", 60) . "\n";
    echo "Всего студентов в базе: {$total}\n";
    
    // Закрываем соединение
    $pdo = null;
    
    echo "\nБаза данных успешно создана: " . realpath($databaseFile) . "\n";
    echo "Размер файла: " . round(filesize($databaseFile) / 1024, 2) . " КБ\n";
    
} catch (PDOException $e) {
    die("Ошибка создания базы данных: " . $e->getMessage());
}
?>